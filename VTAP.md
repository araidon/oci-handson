# OCIハンズオン-VTAP編

1. ハンズオン-前提と構成イメージ
2. 動作確認用事前準備
3. VTAP設定
4. VTAP設定

## 1. ハンズオン-前提と構成イメージ
- VCNの作成が完了しており、そのVCN内にデフォルトのプライベート・サブネットとパブリック・サブネットが作成されていること
   - 本ハンズオンはVCN[10.0.0.0/16],パブリックサブネット[10.0.0.0/24],プライベートサブネット[10.0.1.0/24]を前提としています
- パブリック・サブネットにSSH接続が可能な環境があること

・ハンズオン完成イメージ
![VTAP完成イメージ](https://github.com/user-attachments/assets/09bb4643-c8fb-48d0-9ae3-1e6f19f5619d)


## 2. 動作確認用事前準備

### 2-1. Compute作成1.パブリックサブネットクライアント用の作成
1. コンソールのナビゲーションメニューから [コンピュート]→ [インスタンス]を選択
2. インスタンスの作成を選択
3. 以下の設定で作成。下記以外はデフォルトのまま。

|大項目|中項目|設定値|
|---|---|---|
|名前||ClientVM|
|コンパートメントに作成||（自分のコンパートメント）|
|イメージとシェイプ|イメージ|OracleLinux|
||Shape|AMD - VM.Standard.E4.Flex|
|プライマリVNIC情報の編集|VCN|（作成済みのVCN）|
||サブネット|作成済みのパブリック・サブネット|
|SSHキーの追加||キーペアの自動生成（＆キーのダウンロード）<br>or 作成済みの公開キーのアップロード|

### 2-2. Compute作成2.プライベートサブネットPing受信サーバ用
1. コンソールのナビゲーションメニューから [コンピュート]→ [インスタンス]を選択
2. インスタンスの作成を選択
3. 以下の設定で作成。下記以外はデフォルトのまま。

|大項目|中項目|設定値|
|---|---|---|
|名前||ServerVM|
|コンパートメントに作成||（自分のコンパートメント）|
|イメージとシェイプ|イメージ|OracleLinux|
||Shape|AMD - VM.Standard.E4.Flex|
|プライマリVNIC情報の編集|VCN|（作成済みのVCN）|
||サブネット|作成済みのプライベート・サブネット|
||プライベートIPv4アドレス|プライベートIPv4アドレスの手動割当て→10.0.1.2|
|SSHキーの追加||キーペアの自動生成（＆キーのダウンロード）<br>or 作成済みの公開キーのアップロード|


### 2-3. Compute作成3.VTAP受信用
1. コンソールのナビゲーションメニューから [コンピュート]→ [インスタンス]を選択
2. インスタンスの作成を選択
3. 以下の設定で作成。下記以外はデフォルトのまま。

|大項目|中項目|設定値|
|---|---|---|
|名前||TargetVM|
|コンパートメントに作成||（自分のコンパートメント）|
|イメージとシェイプ|イメージ|OracleLinux|
||Shape|AMD - VM.Standard.E4.Flex|
|プライマリVNIC情報の編集|VCN|（作成済みのVCN）|
||サブネット|作成済みのプライベート・サブネット|
||プライベートIPv4アドレス|プライベートIPv4アドレスの手動割当て→10.0.1.3|
|SSHキーの追加||キーペアの自動生成（＆キーのダウンロード）<br>or 作成済みの公開キーのアップロード|

・ここまでで以下の3台のComputeインスタンスを作成

![CleanShot 2024-09-09 at 15 29 05](https://github.com/user-attachments/assets/51164911-05f3-4ec5-ab87-852cd010c2cd)


### 2-4. 設定1. プライベートサブネットのセキュリティリスト編集( ping許可用)
1. コンソールのナビゲーションメニューから [ネットワーキング]→ [仮想クラウド・ネットワーク]を選択
2. 右ペインから、対象のVCNの名前部分をクリック
3. 画面右下のサブネット一覧からプライベート・サブネットの名前部分をクリック
4. 画面右下のセキュリティ・リストの名前部分をクリック
5. イングレス・ルールの追加をクリック
6. 以下の設定で、Ping疎通の許可設定を作成。下記以外の部分はデフォルトのまま。

|項目|設定値|
|---|---|
|ソースタイプ|CIDR|
|ソースCIDR|10.0.0.0/24|
|IPプロトコル|ICMP|
|タイプ|8|
|ソースタイプ|CIDR|

![CleanShot 2024-09-09 at 15 41 40](https://github.com/user-attachments/assets/046411e3-aac7-482c-a90e-2f49895876e1)

### 2-5. 設定2. Ping受信サーバのファイアウォール停止
1. Ping受信サーバ（ServerVM）にSSHログインする（ClientVMを踏み台にしてのSSH or CloudShellでのログイン)
2. 以下のコマンドを入力して、ServerVM内のファイアウォールを停止する

```
sudo systemctl stop firewalld
```

### 2-6. Ping受信確認
1. パブリックサブネットのサーバ（ClientVM）にSSHログインする
2. 以下のコマンドを入力して、Ping受信サーバにpingする。

```
ping -c 5 10.0.1.2
```

3. 正常にコマンドが成功することを確認（5 packets transmitted, 5 received, 0% packet loss)
![CleanShot 2024-09-09 at 16 21 29](https://github.com/user-attachments/assets/d4e6dca3-260a-4383-bf5a-47ca95010e0c)



### 動作確認手順まとめ
ここまででVTAPの動作確認の準備が完了です。

![VTAP途中イメージ](https://github.com/user-attachments/assets/3f42f2fa-ce1f-4d87-9223-3153cabf531e)



## 3. VTAP設定
ここからはいよいよVTAPの設定を行います。

VTAPはミラーされたパケットを受け取るロードバランサ（NLB）と、
ロードバランサの先にパケット受信用サーバ（2-3で作成済）が必要になります。

### 3-1. ターゲットサーバの設定その1(サーバ)
1. パケット受信サーバ（TargetVM）にSSHログインする（ClientVMを踏み台にしてのSSH or CloudShellでのログイン)
2. 以下のコマンドを入力して、ServerVM内のファイアウォールを停止する

```
sudo systemctl stop firewalld
```

3. 以下のコマンドを入力して、VTAP動作確認用にUDPサーバを建てるためのパッケージをインストールします。

```
sudo yum -y install nmap-ncat.x86_64
```

4. パッケージがインストールされたことを確認（バージョン情報が返ってくればOK）

```
nc -v
```

3. 以下のコマンドを入力して、VTAP動作確認用にUDPサーバを建てる
(49152ポートでリクエストを受信する状態になります。)

```
while true; do (echo "response") | nc -lu 49152 -i 1; done > /dev/null 2>&1 &
```

### 3-2. ターゲットサーバの設定その２(VNIC)
1. コンソールのナビゲーションメニューから [コンピュート]→ [インスタンス]を選択
2. 右ペインのVTAP動作確認サーバ(TargetVM)の名前部分のリンクをクリック
3. 画面下にスクロールして、左ペインの[アタッチされたVNIC]をクリック
4. 画面右下、[アタッチされたVNIC]で一番右の[︙]→[VNICの編集]をクリック

![CleanShot 2024-09-09 at 16 37 45](https://github.com/user-attachments/assets/9c806a36-b03c-4402-b17e-82a156a28d6f)

5. ソース/宛先チェックのスキップにチェックを入れて、変更の保存ボタンをクリック

![CleanShot 2024-09-09 at 16 39 48](https://github.com/user-attachments/assets/151c1dd2-0395-4d1b-8e62-1d4ce1bf026a)


### 3-３. ロードバランサの作成NLB
1. コンソールのナビゲーションメニューから [ネットワーキング]→ [ネットワーク・ロード・バランサ]を選択
2. [ネットワーク・ロード・バランサの作成]をクリック
3. 以下の設定でロードバランサを作成する。下記以外の部分はデフォルトのまま。

|項目|設定値|
|---|---|
|ロードバランサ名|for-vtap|
|可視性タイプ|プライベート|
|ネットワーキング（VCN）|（作成済みのVCNを選択）|
|ネットワーキング（サブネット）|（プライベート・サブネットを選択）|

4. 次へをクリックし、以下の設定でリスナー（ロードバランサが受信するトラフィック）を作成する。下記以外の部分はデフォルトのまま。
   
|項目|設定値|
|---|---|
|リスナー名|NLB-listener|
|トラフィックのタイプ|UDP|
|イングレス・トラフィック・ポート|ポートを指定 → 4789 |

※VTAPはミラーしたパケットを4789に送信する仕様となっております。

5. 次へをクリックし、以下の設定でバックエンドセットを作成します。下記以外の部分はデフォルトのまま。

|大項目|中項目|設定値|
|---|---|---|
|バックエンドセット名||backendset|
|バックエンドの追加をクリック|バックエンド・タイプ|コンピュート・インスタンス|
||コンピュートインスタンス|TargetVM|
||ポート| 49152 |
|ヘルス・チェック・ポリシーの指定|プロトコル|UDP|
||リクエスト・データ| request |
||レスポンス・データ| response |

![CleanShot 2024-09-09 at 16 55 57](https://github.com/user-attachments/assets/b4947e87-ea50-4e08-9a28-b8e5de9625fe)

### 3-4. プライベートサブネットのセキュリティリスト編集(vtap許可用)
1. コンソールのナビゲーションメニューから [ネットワーキング]→ [仮想クラウド・ネットワーク]を選択
2. 右ペインから、対象のVCNの名前部分をクリック
3. 画面右下のサブネット一覧からプライベート・サブネットの名前部分をクリック
4. 画面右下のセキュリティ・リストの名前部分をクリック
5. イングレス・ルールの追加をクリック
6. 以下の設定で、VTAP送受信の許可設定を作成。下記以外の部分はデフォルトのまま。

|項目|設定値|
|---|---|
|ソースタイプ|CIDR|
|ソースCIDR|10.0.1.0/24|
|IPプロトコル|UDP|
|宛先ポート範囲|4789,49152|

![CleanShot 2024-09-09 at 17 37 46](https://github.com/user-attachments/assets/9a64638d-1a8a-46e5-b80e-220e802d1194)


### 3-5. VTAP作成
1. コンソールのナビゲーションメニューから [ネットワーキング]→ [VTAP]を選択
2. 右ペインの[VTAPの作成]をクリック
3. 以下の設定で、VTAPを作成。下記以外の部分はデフォルトのまま。

|大項目|中項目|設定値|
|---|---|---|
|名前||VTAP|
|コンパートメント||(作成済みのコンパートメント)
|VCN||(作成済みのVCN)|
|ソース|ソース・タイプ|インスタンスVNIC|
||サブネット| (プライベートサブネット)|
||VNIC|TargetVMを指定|
|ターゲット|サブネット|(プライベートサブネット)|
||ネットワーク・ロード・バランサ|（先ほど作成したロードバランサ）|
|取得フィルタ|新規取得フィルタの作成||
||名前|ICMP-Filter|
||コンパートメント|(作成済みのコンパートメント)|
||トラフィックの方向|イングレス|
||ソースのIPv4またはIPv6|10.0.0.0/24|
||宛先のIPv4またはIPv6|10.0.1.0/24|
||IPプロトコル|ICMP|




### 3-6. VTAP起動
作成完了後のVTAPは停止中となっているため、[起動]をクリックし、
実行中になったことを確認する。

![CleanShot 2024-09-09 at 17 49 51](https://github.com/user-attachments/assets/01e05fd1-1ac4-42da-935c-d163b5778a40)


## 4. VTAP設定

1. パブリックサブネット用VMのSSHと、TargetVM用の2画面を用意する。
2. (TargetVM)以下のコマンドを実行して、ミラーリングされたパケットを可視化できるようにする。

```
sudo tcpdump src host 10.0.1.2 -vv -i ens3
```

4. (PublicVM)以下のコマンドを実行して、Ping受信サーバにPingを実行する

```
ping -c 5 10.0.1.2
```

6. (TargetVM）Pingの実行結果が見れるようになっていること（＝ミラーリング出来ていること）を確認する


<!-- 以下コメントアウト

## Extra. VPCフローログの設定


## 2. サーバインスタンス作成&ping疎通確認

（すでに自動割り当てされてるプライベートIPアドレスを要確認）プライベートIPアドレスの手動割当 10.0.1.2

拡張オプションの表示は不要

セキュリティリストのpingポートを開ける ← いったんなし

## 3. バックエンドインスタンスの作成

手順と画像は2−1のまんまでOK
同じ設定の49152を作る、をもうちょっと丁寧に書く

ncatコマンドとは
ネットワークの疎通確認コマンド

## 4. NLBの作成
orasejapanはMAX NLB制限にひっかかって断念。

Flexible Network Load Balancer Count	max-nlb-flexible-count の制限解除リクエスト必須

## 5. VTAPの作成

基本的にチュートリアルの通りでOK
要所要所で画像いれないとわけわかんなくなるので作る
最初にVTAPについて詳細を解説する。
解説元はSpeakerdeckで
https://speakerdeck.com/ocise/oci-jia-xiang-tesutoakusesupointo-vtap-gai-yao



## 6. 確認
デモにする

## 確認
このコマンドの意味

（ターゲット・インスタンスに送信されるヘルスチェックのリクエストを受け入れ、レスポンスを返すため、ここではncatコマンドを用います。まずは以下のコマンドでnmap-ncatパッケージをインストールします）
ncコマンドとは

–l
リモートホストへの接続を開始せずに、着信する接続を待機します。

–u
デフォルトのオプションである TCP の代わりに UDP を使用します。

–i interval
テキスト行の送受信間隔 (interval) の遅延時間を指定します。

echoをつけて、responseを受け取ったときの動作とするサーバにする。
responseは、NLBで指定している。

(UDPサーバを建て、NLBのヘルスチェックのリクエストを待機します)
 while true; do (echo "response") | nc -lu 49152 -i 1; done > /dev/null 2>&1 &

(サーバ・インスタンスからミラーリングされて流れてくるパケットを待ち受けます)
 sudo tcpdump src host 10.0.1.2 -vv -i ens3

> src host HOST	パケットの送信元ホストがHOSTであれば真
> -vv	-vよりも詳細に出力する（NFS応答パケットの追加フィールドなども表示される）
> -i INTERFACE	ネットワーク・インターフェースINTERFACEを監視する
> linuxのデフォルトのNIC名はens3

 -->
