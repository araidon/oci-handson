# OCIハンズオン-VTAP編

1. ハンズオン-作業イメージ&前提
2. サーバインスタンス作成&ping疎通確認
3. バックエンドインスタンスの作成
4. NLBの作成
5. VTAPの作成
6. 確認

## 1. ハンズオン-前提と構成イメージ
- VCNの作成が完了しており、そのVCN内にデフォルトのプライベート・サブネットとパブリック・サブネットが作成されていること
- パブリック・サブネットにSSH接続が可能な環境があること

※※※ここに、前提のイメージを入れる※※※
（クライアント-----SSH------OCI-VCN-PublicSubnet-Compute

下記がこのハンズオンで作成できる構成イメージです。
![image](https://github.com/user-attachments/assets/21dafe69-7513-4374-9eb8-55c5d75dbb60)

## 2. 確認用事前準備

### 2-1. Compute作成1.パブリックサブネットクライアント用の作成
1. コンソールのナビゲーションメニューから [コンピュート]→ [インスタンス]を選択
2. インスタンスの作成を選択
3. 以下の設定で作成。下記以外はデフォルトのまま。

|大項目|中項目|設定値|
|---|---|---|
|名前||ClientVM|
|コンパートメントに作成||（自分のコンパートメント）|
|イメージとシェイプ|イメージ|OracleLinux|
||Shape|AMD - VM.Standard.E4.Flex|
|プライマリVNIC情報の編集|VCN|（作成済みのVCN）|
||サブネット|作成済みのパブリック・サブネット|
|SSHキーの追加||キーペアの自動生成（＆キーのダウンロード）<br>or 作成済みの公開キーのアップロード|

### 2-2. Compute作成2.プライベートサブネットPing受信サーバ用
1. コンソールのナビゲーションメニューから [コンピュート]→ [インスタンス]を選択
2. インスタンスの作成を選択
3. 以下の設定で作成。下記以外はデフォルトのまま。

|大項目|中項目|設定値|
|---|---|---|
|名前||ServerVM|
|コンパートメントに作成||（自分のコンパートメント）|
|イメージとシェイプ|イメージ|OracleLinux|
||Shape|AMD - VM.Standard.E4.Flex|
|プライマリVNIC情報の編集|VCN|（作成済みのVCN）|
||サブネット|作成済みのプライベート・サブネット|
||プライベートIPv4アドレス|プライベートIPv4アドレスの手動割当て→10.0.1.2|
|SSHキーの追加||キーペアの自動生成（＆キーのダウンロード）<br>or 作成済みの公開キーのアップロード|


### 2-3. Compute作成3.VTAP受信用
1. コンソールのナビゲーションメニューから [コンピュート]→ [インスタンス]を選択
2. インスタンスの作成を選択
3. 以下の設定で作成。下記以外はデフォルトのまま。

|大項目|中項目|設定値|
|---|---|---|
|名前||TargetVM|
|コンパートメントに作成||（自分のコンパートメント）|
|イメージとシェイプ|イメージ|OracleLinux|
||Shape|AMD - VM.Standard.E4.Flex|
|プライマリVNIC情報の編集|VCN|（作成済みのVCN）|
||サブネット|作成済みのプライベート・サブネット|
||プライベートIPv4アドレス|プライベートIPv4アドレスの手動割当て→10.0.1.3|
|SSHキーの追加||キーペアの自動生成（＆キーのダウンロード）<br>or 作成済みの公開キーのアップロード|

### 2-4. 設定1. プライベートサブネットのセキュリティリスト編集( ping許可用)

### 2-5. 設定2. Ping受信サーバのファイアウォール停止

### 2-6. Ping受信確認

<ここまでのまとめ絵をいれる>



## 3. VTAP設定

### 3-1. ターゲットサーバの設定
1. ファイアウォールの停止
2. ncatパッケージのインストール
3. VTAP動作確認用にUDPサーバを建てる
4. VNIC設定

### 3-2. ロードバランサの作成NLB
- リスナー
- バックエンド

### 3-3. VTAP作成

### 3-4. VTAP起動


## 4. 動作確認

## Extra. VPCフローログの設定


## 2. サーバインスタンス作成&ping疎通確認

（すでに自動割り当てされてるプライベートIPアドレスを要確認）プライベートIPアドレスの手動割当 10.0.1.2

拡張オプションの表示は不要

セキュリティリストのpingポートを開ける ← いったんなし

## 3. バックエンドインスタンスの作成

手順と画像は2−1のまんまでOK
同じ設定の49152を作る、をもうちょっと丁寧に書く

ncatコマンドとは
ネットワークの疎通確認コマンド

## 4. NLBの作成
orasejapanはMAX NLB制限にひっかかって断念。

Flexible Network Load Balancer Count	max-nlb-flexible-count の制限解除リクエスト必須

## 5. VTAPの作成

基本的にチュートリアルの通りでOK
要所要所で画像いれないとわけわかんなくなるので作る
最初にVTAPについて詳細を解説する。
解説元はSpeakerdeckで
https://speakerdeck.com/ocise/oci-jia-xiang-tesutoakusesupointo-vtap-gai-yao



## 6. 確認
デモにする

## 確認
このコマンドの意味

（ターゲット・インスタンスに送信されるヘルスチェックのリクエストを受け入れ、レスポンスを返すため、ここではncatコマンドを用います。まずは以下のコマンドでnmap-ncatパッケージをインストールします）
ncコマンドとは

–l
リモートホストへの接続を開始せずに、着信する接続を待機します。

–u
デフォルトのオプションである TCP の代わりに UDP を使用します。

–i interval
テキスト行の送受信間隔 (interval) の遅延時間を指定します。

echoをつけて、responseを受け取ったときの動作とするサーバにする。
responseは、NLBで指定している。

(UDPサーバを建て、NLBのヘルスチェックのリクエストを待機します)
 while true; do (echo "response") | nc -lu 49152 -i 1; done > /dev/null 2>&1 &

(サーバ・インスタンスからミラーリングされて流れてくるパケットを待ち受けます)
 sudo tcpdump src host 10.0.1.2 -vv -i ens3

> src host HOST	パケットの送信元ホストがHOSTであれば真
> -vv	-vよりも詳細に出力する（NFS応答パケットの追加フィールドなども表示される）
> -i INTERFACE	ネットワーク・インターフェースINTERFACEを監視する
> linuxのデフォルトのNIC名はens3

